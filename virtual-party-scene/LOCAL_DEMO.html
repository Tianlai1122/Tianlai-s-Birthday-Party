<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‰ Tianlai's Club - æœ¬åœ°æ¼”ç¤ºç‰ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .demo-notice {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            border-bottom: 3px solid #ffc107;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .character-count {
            font-size: 1.2em;
            font-weight: 600;
            color: #667eea;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .canvas-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #partyCanvas {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #f0f4ff;
            border-color: #5568d3;
        }

        .upload-area.drag-over {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        #cropperContainer {
            max-height: 400px;
            margin: 20px 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .option-item {
            position: relative;
        }

        .option-item input[type="radio"] {
            position: absolute;
            opacity: 0;
        }

        .option-item label {
            display: block;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 4px solid #667eea;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step.active {
            background: #667eea;
            color: white;
        }

        .step.completed {
            background: #22a6b3;
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .character-info-modal .character-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .character-info-modal .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid #667eea;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .messages-section {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .message-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .message-input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .message-input-group input {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="demo-notice">
        âš ï¸ æœ¬åœ°æ¼”ç¤ºç‰ˆ - æ•°æ®ä»…ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œåˆ·æ–°é¡µé¢åä¼šä¸¢å¤±
    </div>

    <div class="header">
        <h1>ğŸ‰ Tianlai's Club</h1>
        <p>è™šæ‹Ÿæ´¾å¯¹åœºæ™¯ - æœ¬åœ°æ¼”ç¤ºç‰ˆ</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="character-count">
                è§’è‰²æ•°é‡: <span id="characterCount">0</span> / 50
            </div>
            <button class="btn-primary" onclick="openUploadModal()">ğŸŠ åŠ å…¥æ´¾å¯¹</button>
            <button class="btn-primary" onclick="clearAllCharacters()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>

        <div class="canvas-section">
            <canvas id="partyCanvas" width="1200" height="700"></canvas>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>åˆ›å»ºä½ çš„è§’è‰²</h2>
                <button class="close-btn" onclick="closeUploadModal()">&times;</button>
            </div>

            <div class="step-indicator">
                <div class="step active" id="step1">1</div>
                <div class="step" id="step2">2</div>
                <div class="step" id="step3">3</div>
            </div>

            <!-- Step 1: Upload -->
            <div id="uploadStep" class="step-content">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <p style="font-size: 3em; margin-bottom: 10px;">ğŸ“¸</p>
                    <p style="font-size: 1.2em; font-weight: 600;">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç…§ç‰‡</p>
                    <p style="color: #999; margin-top: 10px;">æ”¯æŒ JPG/PNGï¼Œæœ€å¤§ 5MB</p>
                </div>
                <input type="file" id="fileInput" accept="image/jpeg,image/png" style="display: none;">
            </div>

            <!-- Step 2: Crop -->
            <div id="cropStep" class="step-content" style="display: none;">
                <div id="cropperContainer"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(1)">â† è¿”å›</button>
                    <button class="btn btn-primary" onclick="confirmCrop()">ç¡®è®¤è£å‰ª â†’</button>
                </div>
            </div>

            <!-- Step 3: Customize -->
            <div id="customizeStep" class="step-content" style="display: none;">
                <div class="avatar-preview">
                    <img id="avatarPreview" src="" alt="Avatar">
                </div>

                <div class="form-group">
                    <label>æ˜µç§° *</label>
                    <input type="text" id="displayName" maxlength="20" placeholder="è¾“å…¥ä½ çš„æ˜µç§°">
                    <div class="error-message" id="nameError"></div>
                </div>

                <div class="form-group">
                    <label>èº«ä½“é£æ ¼</label>
                    <div class="option-grid">
                        <div class="option-item">
                            <input type="radio" name="bodyStyle" value="casual" id="casual" checked>
                            <label for="casual">ğŸ‘• ä¼‘é—²</label>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="bodyStyle" value="formal" id="formal">
                            <label for="formal">ğŸ¤µ æ­£å¼</label>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="bodyStyle" value="party" id="party">
                            <label for="party">ğŸ‰ æ´¾å¯¹</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>ç§»åŠ¨æ–¹å¼</label>
                    <div class="option-grid">
                        <div class="option-item">
                            <input type="radio" name="transport" value="walk" id="walk" checked>
                            <label for="walk">ğŸš¶ èµ°è·¯</label>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="transport" value="balloon" id="balloon">
                            <label for="balloon">ğŸˆ æ°”çƒ</label>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="transport" value="skate" id="skate">
                            <label for="skate">ğŸ›¹ æ»‘æ¿</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>åŠ¨ä½œ</label>
                    <div class="option-grid">
                        <div class="option-item">
                            <input type="radio" name="action" value="idle" id="idle" checked>
                            <label for="idle">ğŸ§ ç«™ç«‹</label>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="action" value="wave" id="wave">
                            <label for="wave">ğŸ‘‹ æŒ¥æ‰‹</label>
                        </div>
                        <div class="option-item">
                            <input type="radio" name="action" value="dance" id="dance">
                            <label for="dance">ğŸ’ƒ è·³èˆ</label>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="goToStep(2)">â† è¿”å›</button>
                    <button class="btn btn-primary" onclick="createCharacter()">åˆ›å»ºè§’è‰² âœ¨</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Info Modal -->
    <div id="characterModal" class="modal character-info-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è§’è‰²ä¿¡æ¯</h2>
                <button class="close-btn" onclick="closeCharacterModal()">&times;</button>
            </div>
            <div id="characterInfo"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        // æœ¬åœ°å­˜å‚¨çš„è§’è‰²æ•°æ®
        let characters = JSON.parse(localStorage.getItem('partyCharacters') || '[]');
        let cropper = null;
        let croppedImageData = null;
        let currentStep = 1;

        // Canvas è®¾ç½®
        const canvas = document.getElementById('partyCanvas');
        const ctx = canvas.getContext('2d');

        // åˆå§‹åŒ–
        function init() {
            renderScene();
            updateCharacterCount();
            setupEventListeners();
        }

        function setupEventListeners() {
            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // Canvas ç‚¹å‡»
            canvas.addEventListener('click', handleCanvasClick);
            
            // æ‹–æ‹½ä¸Šä¼ 
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            // éªŒè¯æ–‡ä»¶
            if (!file.type.match('image/(jpeg|png)')) {
                alert('è¯·ä¸Šä¼  JPG æˆ– PNG æ ¼å¼çš„å›¾ç‰‡');
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');
                return;
            }

            // è¯»å–æ–‡ä»¶
            const reader = new FileReader();
            reader.onload = (e) => {
                showCropper(e.target.result);
                goToStep(2);
            };
            reader.readAsDataURL(file);
        }

        function showCropper(imageSrc) {
            const container = document.getElementById('cropperContainer');
            container.innerHTML = '<img id="cropImage" src="' + imageSrc + '">';
            
            const image = document.getElementById('cropImage');
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                background: false
            });
        }

        function confirmCrop() {
            if (!cropper) return;
            
            const canvas = cropper.getCroppedCanvas({
                width: 200,
                height: 200
            });
            
            croppedImageData = canvas.toDataURL('image/png');
            document.getElementById('avatarPreview').src = croppedImageData;
            goToStep(3);
        }

        function goToStep(step) {
            currentStep = step;
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById('step' + i);
                stepEl.classList.remove('active', 'completed');
                if (i < step) stepEl.classList.add('completed');
                if (i === step) stepEl.classList.add('active');
            }
            
            // æ˜¾ç¤ºå¯¹åº”æ­¥éª¤
            document.getElementById('uploadStep').style.display = step === 1 ? 'block' : 'none';
            document.getElementById('cropStep').style.display = step === 2 ? 'block' : 'none';
            document.getElementById('customizeStep').style.display = step === 3 ? 'block' : 'none';
        }

        function createCharacter() {
            const displayName = document.getElementById('displayName').value.trim();
            
            if (!displayName) {
                const error = document.getElementById('nameError');
                error.textContent = 'è¯·è¾“å…¥æ˜µç§°';
                error.classList.add('show');
                return;
            }
            
            if (characters.length >= 50) {
                alert('æ´¾å¯¹å·²æ»¡ï¼æœ€å¤š 50 ä¸ªè§’è‰²');
                return;
            }
            
            const character = {
                id: Date.now(),
                displayName,
                avatarUrl: croppedImageData,
                bodyStyle: document.querySelector('input[name="bodyStyle"]:checked').value,
                transport: document.querySelector('input[name="transport"]:checked').value,
                action: document.querySelector('input[name="action"]:checked').value,
                position: {
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: Math.random() * (canvas.height - 140) + 70
                },
                likes: 0,
                messages: [],
                joinedAt: new Date().toISOString()
            };
            
            characters.push(character);
            saveCharacters();
            renderScene();
            updateCharacterCount();
            closeUploadModal();
            
            alert('ğŸ‰ è§’è‰²åˆ›å»ºæˆåŠŸï¼');
        }

        function saveCharacters() {
            localStorage.setItem('partyCharacters', JSON.stringify(characters));
        }

        function renderScene() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#e3f2fd');
            gradient.addColorStop(1, '#fff9c4');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶è£…é¥°
            drawDecorations();
            
            // ç»˜åˆ¶è§’è‰²
            characters.forEach(char => drawCharacter(char));
        }

        function drawDecorations() {
            // ç»˜åˆ¶å½©çº¸
            ctx.globalAlpha = 0.3;
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 10 + 5;
                const colors = ['#ff6b9d', '#667eea', '#ffa502', '#22a6b3'];
                ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                ctx.fillRect(x, y, size, size);
            }
            ctx.globalAlpha = 1;
        }

        function drawCharacter(char) {
            const { x, y } = char.position;
            
            // èº«ä½“é¢œè‰²
            const bodyColors = {
                casual: '#4a90e2',
                formal: '#2c3e50',
                party: '#ff6b9d'
            };
            
            // ç»˜åˆ¶é˜´å½±
            ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.beginPath();
            ctx.ellipse(x, y + 45, 35, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶ç§»åŠ¨æ–¹å¼å›¾æ ‡
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            const transportIcons = { walk: 'ğŸš¶', balloon: 'ğŸˆ', skate: 'ğŸ›¹' };
            ctx.fillText(transportIcons[char.transport], x - 30, y - 20);
            
            // ç»˜åˆ¶èº«ä½“
            ctx.fillStyle = bodyColors[char.bodyStyle];
            ctx.beginPath();
            ctx.arc(x, y, 30, 0, Math.PI * 2);
            ctx.fill();
            
            // ç»˜åˆ¶å¤´åƒ
            if (char.avatarUrl) {
                const img = new Image();
                img.src = char.avatarUrl;
                ctx.save();
                ctx.beginPath();
                ctx.arc(x, y - 10, 22, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(img, x - 22, y - 32, 44, 44);
                ctx.restore();
                
                // å¤´åƒè¾¹æ¡†
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x, y - 10, 22, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // ç»˜åˆ¶åŠ¨ä½œå›¾æ ‡
            const actionIcons = { idle: 'ğŸ§', wave: 'ğŸ‘‹', dance: 'ğŸ’ƒ' };
            ctx.fillText(actionIcons[char.action], x + 30, y - 20);
            
            // ç»˜åˆ¶åå­—
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.fillText(char.displayName, x, y + 50);
            
            // ç»˜åˆ¶ç‚¹èµæ•°
            ctx.font = '12px Arial';
            ctx.fillText(`â¤ï¸ ${char.likes}`, x, y + 65);
        }

        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            // æŸ¥æ‰¾ç‚¹å‡»çš„è§’è‰²
            for (let i = characters.length - 1; i >= 0; i--) {
                const char = characters[i];
                const dx = x - char.position.x;
                const dy = y - char.position.y;
                
                if (Math.abs(dx) < 40 && Math.abs(dy) < 70) {
                    showCharacterInfo(char);
                    break;
                }
            }
        }

        function showCharacterInfo(char) {
            const modal = document.getElementById('characterModal');
            const info = document.getElementById('characterInfo');
            
            const joinTime = new Date(char.joinedAt);
            const timeAgo = getTimeAgo(joinTime);
            
            info.innerHTML = `
                <div class="character-header">
                    <div class="avatar-large">
                        <img src="${char.avatarUrl}" style="width: 100%; height: 100%; border-radius: 50%;">
                    </div>
                    <h3>${char.displayName}</h3>
                    <p style="color: #999;">åŠ å…¥äº ${timeAgo}</p>
                </div>
                
                <div class="info-row">
                    <span>èº«ä½“é£æ ¼:</span>
                    <span>${{ casual: 'ğŸ‘• ä¼‘é—²', formal: 'ğŸ¤µ æ­£å¼', party: 'ğŸ‰ æ´¾å¯¹' }[char.bodyStyle]}</span>
                </div>
                <div class="info-row">
                    <span>ç§»åŠ¨æ–¹å¼:</span>
                    <span>${{ walk: 'ğŸš¶ èµ°è·¯', balloon: 'ğŸˆ æ°”çƒ', skate: 'ğŸ›¹ æ»‘æ¿' }[char.transport]}</span>
                </div>
                <div class="info-row">
                    <span>åŠ¨ä½œ:</span>
                    <span>${{ idle: 'ğŸ§ ç«™ç«‹', wave: 'ğŸ‘‹ æŒ¥æ‰‹', dance: 'ğŸ’ƒ è·³èˆ' }[char.action]}</span>
                </div>
                <div class="info-row">
                    <span>ç‚¹èµæ•°:</span>
                    <span>â¤ï¸ ${char.likes}</span>
                </div>
                
                <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="likeCharacter(${char.id})">
                    â¤ï¸ ç‚¹èµ
                </button>
                
                <div class="messages-section">
                    <h4>ç•™è¨€ (${char.messages.length})</h4>
                    <div id="messagesList">
                        ${char.messages.length === 0 ? '<p style="color: #999; text-align: center; padding: 20px;">è¿˜æ²¡æœ‰ç•™è¨€</p>' : 
                          char.messages.map(m => `
                            <div class="message-item">
                                <div style="font-weight: 600;">${m.author}</div>
                                <div>${m.content}</div>
                                <div style="color: #999; font-size: 0.9em; margin-top: 5px;">${getTimeAgo(new Date(m.timestamp))}</div>
                            </div>
                          `).join('')}
                    </div>
                    <div class="message-input-group">
                        <input type="text" id="messageInput" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..." maxlength="200">
                        <button class="btn btn-primary" onclick="sendMessage(${char.id})">å‘é€</button>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function likeCharacter(id) {
            const char = characters.find(c => c.id === id);
            if (char) {
                char.likes++;
                saveCharacters();
                renderScene();
                showCharacterInfo(char);
            }
        }

        function sendMessage(id) {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }
            
            const char = characters.find(c => c.id === id);
            if (char) {
                char.messages.push({
                    author: 'è®¿å®¢',
                    content,
                    timestamp: new Date().toISOString()
                });
                saveCharacters();
                input.value = '';
                showCharacterInfo(char);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'åˆšåˆš';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} åˆ†é’Ÿå‰`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} å°æ—¶å‰`;
            const days = Math.floor(hours / 24);
            return `${days} å¤©å‰`;
        }

        function updateCharacterCount() {
            document.getElementById('characterCount').textContent = characters.length;
        }

        function openUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
            goToStep(1);
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            document.getElementById('fileInput').value = '';
            document.getElementById('displayName').value = '';
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').classList.remove('active');
        }

        function clearAllCharacters() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è§’è‰²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                characters = [];
                saveCharacters();
                renderScene();
                updateCharacterCount();
            }
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>

